{% extends 'base.html' %}
{% load static %}
{% block title %}Оформление заказа{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/orders/order_create.css' %}">
{% endblock %}
{% block content %}
  <main class="order-page">
    <form method="post" class="order-container">
      {% csrf_token %}
      <div class="order-form">
        <h2>Условия заказа</h2>
        <label for="{{ form.address.id_for_label }}">
          <img src="{% static 'imgs/icons/home-icon.svg' %}" alt="" class="icon">
          Адрес заведения
        </label>
        {{ form.address }}
        <label for="{{ form.time.id_for_label }}">
          <img src="{% static 'imgs/icons/clock-icon.svg' %}" alt="" class="icon">
          Время приготовления
        </label>
        {{ form.time }}
        <label for="{{ form.comment.id_for_label }}">Комментарий к заказу</label>
        {{ form.comment }}
        <div class="order-footer">
          <button class="checkout" type="submit">Оплатить</button>
          <div class="total-price" id="total-price">{{ total_price }}₽</div>
        </div>
      </div>
      <div class="order-summary">
        <div class="order-summary-header">
          <h2>Ваш заказ</h2>
          {% if items %}
            <button type="button" class="clear-cart">Очистить корзину</button>
          {% endif %}
        </div>
        {% if items %}
          {% include 'orders/_order_items.html' %}
        {% else %}
          <div class="empty-cart">
            <img src="{% static 'imgs/empty-cart.png' %}" alt="Ваша корзина пуста">
            <p>Ваша корзина пуста!</p>
            <a href="{% url 'place_list' %}" class="btn">Перейти в каталог →</a>
          </div>
        {% endif %}
      </div>
    </form>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const csrfToken = "{{ csrf_token }}";
      
      async function refreshOrderItems() {
        const response = await fetch('/orders/order-items-partial/');
        if (response.ok) {
          const data = await response.json();
          
          const orderSummary = document.querySelector('.order-summary');
          
          // Check if cart is empty
          if (data.is_empty) {
            // Create empty cart message
            const emptyCartHTML = `
              <div class="order-summary-header">
                <h2>Ваш заказ</h2>
              </div>
              <div class="empty-cart">
                <img src="{% static 'imgs/empty-cart.png' %}" alt="Ваша корзина пуста">
                <p>Ваша корзина пуста!</p>
                <a href="{% url 'place_list' %}" class="btn">Перейти в каталог →</a>
              </div>
            `;
            orderSummary.innerHTML = emptyCartHTML;
          } else {
            // Вставляем новый HTML блока товаров
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = data.html;
            const newOrderItems = tempDiv.querySelector('#order-items');
            const orderItemsBlock = document.getElementById('order-items');
            if (newOrderItems && orderItemsBlock) {
              orderItemsBlock.replaceWith(newOrderItems);
            }
          }
          
          // Обновляем итоговую сумму
          const totalPriceBlock = document.getElementById('total-price');
          if (totalPriceBlock && data.total_price !== undefined) {
            totalPriceBlock.textContent = data.total_price + '₽';
          }
        }
      }

      // Очистка корзины
      document.querySelector('.order-summary').addEventListener('click', async (e) => {
        if (e.target.classList.contains('clear-cart')) {
          try {
            const response = await fetch('/cart/clear-ajax/', {
              method: 'POST',
              headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
              },
            });
            if (response.ok) {
              await refreshOrderItems();
            } else {
              alert('Ошибка очистки корзины');
            }
          } catch (error) {
            alert('Произошла ошибка при обработке запроса');
          }
        }
      });

      document.body.addEventListener('click', async (e) => {
        if (e.target.classList.contains('item-qty-btn')) {
          const btn = e.target;
          const itemId = btn.dataset.itemId;
          const qtySpan = btn.parentElement.querySelector('.item-qty');
          let currentQty = parseInt(qtySpan.textContent, 10);
          let newQty = currentQty;
          
          if (btn.classList.contains('plus')) {
            newQty = currentQty + 1;
          } else if (btn.classList.contains('minus')) {
            newQty = currentQty - 1;
          }
          
          if (newQty <= 0) {
            // Remove item from cart
            try {
              const response = await fetch(`/cart/remove-ajax/${itemId}/`, {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrfToken,
                  'X-Requested-With': 'XMLHttpRequest',
                },
              });
              if (response.ok) {
                await refreshOrderItems();
              } else {
                alert('Ошибка удаления товара из корзины');
              }
            } catch (error) {
              alert('Произошла ошибка при обработке запроса');
            }
          } else {
            // Update item quantity
            try {
              const formData = new FormData();
              formData.append('quantity', newQty);
              const response = await fetch(`/cart/update-ajax/${itemId}/`, {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrfToken,
                  'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData,
              });
              if (response.ok) {
                await refreshOrderItems();
              } else {
                alert('Ошибка обновления количества товара');
              }
            } catch (error) {
              alert('Произошла ошибка при обработке запроса');
            }
          }
        }
      });
    });
  </script>
{% endblock %}
