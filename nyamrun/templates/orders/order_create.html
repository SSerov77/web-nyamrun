{% extends 'base.html' %}
{% load static %}
{% block title %}Оформление заказа{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/orders/order_create.css' %}">
{% endblock %}
{% block content %}
  <main class="order-page">
    <form method="post" class="order-container">
      {% csrf_token %}
      <div class="order-form">
        <h2>Условия заказа</h2>
        <label for="{{ form.address.id_for_label }}">
          <img src="{% static 'imgs/icons/home-icon.svg' %}" alt="" class="icon">
          Адрес заведения
        </label>
        {{ form.address }}
        <label for="{{ form.time.id_for_label }}">
          <img src="{% static 'imgs/icons/clock-icon.svg' %}" alt="" class="icon">
          Время приготовления
        </label>
        {{ form.time }}
        <label for="{{ form.comment.id_for_label }}">Комментарий к заказу</label>
        {{ form.comment }}
        <div class="order-footer">
          <button class="checkout" type="submit">Оплатить</button>
          <div class="total-price">{{ total_price|default:"0" }}₽</div>
        </div>
      </div>
      <div class="order-summary">
        <h2>Ваш заказ</h2>
        {% if items %}
          <ul class="order-items">
            {% for item in items %}
              <li>
                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
                <div class="item-main-info">
                  <span class="item-title">{{ item.product.name }}</span>
                  {% if item.options.all %}
                    <div class="item-options-col">
                      {% for option in item.options.all %}
                        <span class="item-option">{{ option.name }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
                <div class="item-quantity">
                  <div class="item-qty-bg">
                    <button type="button" class="item-qty-btn minus" data-item-id="{{ item.id }}">−</button>
                    <span class="item-qty">{{ item.quantity }}</span>
                    <button type="button" class="item-qty-btn plus" data-item-id="{{ item.id }}">+</button>
                  </div>
                </div>
                <span class="item-price">{{ item.get_total_price }}₽</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty-cart">
            <img src="{% static 'imgs/empty-cart.png' %}" alt="Ваша корзина пуста">
            <p>Ваша корзина пуста!</p>
            <a href="{% url 'place_list' %}" class="btn">Перейти в каталог →</a>
          </div>
        {% endif %}
      </div>
    </form>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const csrfToken = "{{ csrf_token }}";
      
      document.querySelector('.order-items').addEventListener('click', async (e) => {
        if (e.target.classList.contains('item-qty-btn')) {
          const btn = e.target;
          const itemId = btn.dataset.itemId;
          const qtySpan = btn.parentElement.querySelector('.item-qty');
          let currentQty = parseInt(qtySpan.textContent, 10);
          let newQty = currentQty;
          
          if (btn.classList.contains('plus')) {
            newQty = currentQty + 1;
          } else if (btn.classList.contains('minus')) {
            newQty = currentQty - 1;
          }
          
          if (newQty <= 0) {
            // Remove item from cart
            try {
              const response = await fetch(`/cart/remove-ajax/${itemId}/`, {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrfToken,
                  'X-Requested-With': 'XMLHttpRequest',
                },
              });
              if (response.ok) {
                // Reload the page to show updated cart
                window.location.reload();
              } else {
                alert('Ошибка удаления товара из корзины');
              }
            } catch (error) {
              alert('Произошла ошибка при обработке запроса');
            }
          } else {
            // Update item quantity
            try {
              const formData = new FormData();
              formData.append('quantity', newQty);
              const response = await fetch(`/cart/update-ajax/${itemId}/`, {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrfToken,
                  'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData,
              });
              if (response.ok) {
                // Reload the page to show updated cart
                window.location.reload();
              } else {
                alert('Ошибка обновления количества товара');
              }
            } catch (error) {
              alert('Произошла ошибка при обработке запроса');
            }
          }
        }
      });
    });
  </script>
{% endblock %}
