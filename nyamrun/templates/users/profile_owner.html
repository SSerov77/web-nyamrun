{% extends 'base.html' %}
{% load static %}

{% block title %}Личный кабинет владельца{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/users/profile_owner.css' %}">
{% endblock %}

{% block content %}
<div class="owner-dashboard">
  <h2>Личный кабинет владельца</h2>
  <form method="get" class="dashboard-filters" style="margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    <label>
      Заведение:
      <select name="place" onchange="this.form.submit()">
        {% for place in places %}
          <option value="{{ place.id }}" {% if place.id == selected_place.id %}selected{% endif %}>{{ place.name }}</option>
        {% endfor %}
      </select>
    </label>
    <label>
      Период:
      <select name="period" onchange="this.form.submit()">
        <option value="day" {% if selected_period == 'day' %}selected{% endif %}>День</option>
        <option value="week" {% if selected_period == 'week' %}selected{% endif %}>Неделя</option>
        <option value="month" {% if selected_period == 'month' %}selected{% endif %}>Месяц</option>
      </select>
    </label>
  </form>
  {# Блоки заведений #}
  {% for place in places %}
    <div class="place-info-block">
      <img src="{{ place.image.url }}" alt="{{ place.name }}" class="place-info-img">
      <div class="place-info-details">
        <div class="place-info-title">{{ place.name }}</div>
        <div class="place-info-cat">
          Категории:
          {% for cat in place.categories.all %}
            {{ cat.name }}{% if not forloop.last %}, {% endif %}
          {% empty %}
            <span style="color:#888;">нет категорий</span>
          {% endfor %}
        </div>
        <div class="place-info-addr">
          Адреса:
          {% for addr in place.addresses.all %}
            {{ addr }}{% if not forloop.last %}; {% endif %}
          {% empty %}
            <span style="color:#888;">нет адреса</span>
          {% endfor %}
        </div>
        <div class="place-info-type">Тип: {{ place.get_type_display }}</div>
        <div class="place-info-type">Время работы: {{ place.working_hours }}</div>
      </div>
    </div>
  {% endfor %}

  <h3>Общая статистика</h3>
  <div class="charts-grid">
    <div class="chart-card">
      <table>
        <tr><th>Всего заказов</th><td>{{ stats.total_orders }}</td></tr>
        <tr><th>Общая выручка</th><td>{{ stats.total_revenue }} ₽</td></tr>
        <tr><th>Средний чек</th><td>{{ stats.average_check|floatformat:2 }} ₽</td></tr>
      </table>
      <h4>Заказы по статусам</h4>
      <table>
        {% for status in stats.status_breakdown %}
          <tr>
            <td>{{ status.status }}</td>
            <td>{{ status.count }}</td>
          </tr>
        {% endfor %}
      </table>
    </div>
  
    <div class="chart-card">
      <h4>График заказов</h4>
      <div class="chart-wrapper">
        <canvas id="ordersChart"></canvas>
      </div>
    </div>
  </div>
  
  <h3>Статистика по адресам</h3>
  <div class="charts-grid">
    {% for item in address_stats %}
      <div class="chart-card">
        <h4>{{ item.address }}</h4>
        <table>
          <tr><th>Заказов</th><td>{{ item.total_orders }}</td></tr>
          <tr><th>Выручка</th><td>{{ item.total_revenue }} ₽</td></tr>
          <tr><th>Средний чек</th><td>{{ item.average_check|floatformat:2 }} ₽</td></tr>
        </table>
      </div>
    {% empty %}
      <div class="empty-chart">Нет данных по адресам</div>
    {% endfor %}
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('ordersChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [{% for point in stats.orders_chart %}"{{ point.label }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Количество заказов',
        data: [{% for point in stats.orders_chart %}{{ point.value }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
</script>
{% endblock %}